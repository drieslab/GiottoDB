
# dbData ####
## Empty ####
### Extract [] ####
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbData', i = 'missing', j = 'missing', drop = 'missing'),
          function(x, i, j) {
            x@data
          })



### Set [] ####
# no initialize to prevent slowdown
#' @rdname hidden_aliases
#' @export
setMethod('[<-', signature(x = 'dbData', i = 'missing', j = 'missing', value = 'ANY'),
          function(x, i, j, value) {
            x@data = value
            x
          })




# dbMatrix ####
## rows only ####
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbMatrix', i = 'gdbIndex', j = 'missing', drop = 'missing'),
          function(x, i, ...) {
            select = get_dbM_sub_i(index = i, dbM_dimnames = x@dim_names)
            x@dim_names[[1L]] = select
            x[] = x[] %>% dplyr::filter(i %in% select)
            x@dims[1L] = if(is.logical(i)) sum(i) else length(i)
            x
          })

## cols only ####
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbMatrix', i = 'missing', j = 'gdbIndex', drop = 'missing'),
          function(x, j, ...) {
            select = get_dbM_sub_j(index = j, dbM_dimnames = x@dim_names)
            x@dim_names[[2L]] = select
            x[] = x[] %>% dplyr::filter(j %in% select)
            x@dims[2L] = if(is.logical(j)) sum(j) else length(j)
            x
          })
## rows and cols ####
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbMatrix', i = 'gdbIndex', j = 'gdbIndex', drop = 'missing'),
          function(x, i, j, ...) {
            select_i = get_dbM_sub_i(index = i, dbM_dimnames = x@dim_names)
            select_j = get_dbM_sub_j(index = j, dbM_dimnames = x@dim_names)
            x@dim_names[[1L]] = select_i
            x@dim_names[[2L]] = select_j
            x[] = x[] %>% dplyr::filter(i %in% select_i, j %in% select_j)
            x@dims[1L] = if(is.logical(i)) sum(i) else length(i)
            x@dims[2L] = if(is.logical(j)) sum(j) else length(j)
            x
          })


#' @noRd
get_dbM_sub_i = function(index, dbM_dimnames) {
  if(is.character(index)) return(index)
  i_names = dbM_dimnames[[1L]]
  return(i_names[index])
}
#' @noRd
get_dbM_sub_j = function(index, dbM_dimnames) {
  if(is.character(index)) return(index)
  j_names = dbM_dimnames[[2L]]
  return(j_names[index])
}


# dbDataFrame ####
## rows only ####
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbDataFrame', i = 'gdbIndex', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x = reconnect(x)
    if(any(is.na(x@key))) stopf('Set dbDataFrame key with `keyCol()` to subset on \'i\'')

    # numerics and logical
    if(is.logical(i) | is.numeric(i)) {
      if(is.logical(i)) i = which(i)
      x@data = x@data %>%
        flex_window_order(x@key) %>%
        dplyr::mutate(.n = dplyr::row_number()) %>%
        dplyr::collapse() %>%
        dplyr::filter(.n %in% i) %>%
        dplyr::select(-.n) %>%
        dplyr::collapse()
    } else { # character
      x@data = x@data %>%
        flex_window_order(x@key) %>%
        dplyr::filter(!!as.name(x@key) %in% i) %>%
        dplyr::collapse()
    }
    x
  })
## cols only ####
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbDataFrame', i = 'missing', j = 'gdbIndex', drop = 'ANY'),
          function(x, j, ..., drop = FALSE) {
            x = reconnect(x)
            checkmate::assert_logical(drop)

            if(is.logical(j)) j = which(j)
            x@data = x@data %>% dplyr::select(dplyr::all_of(j))
            x
          })
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbDataFrame', i = 'gdbIndex', j = 'gdbIndex', drop = 'ANY'),
          function(x, i, j, ..., drop = FALSE) {
            x = reconnect(x)
            x = x[i,]
            x = x[, j]
            x
          })
## Empty ####
### Extract [] ####
#' @rdname hidden_aliases
#' @export
setMethod('[', signature(x = 'dbDataFrame', i = 'missing', j = 'missing', drop = 'ANY'),
          function(x, i, j, drop = FALSE) {
            x@data
          })
### Set [] ####
# no initialize to prevent slowdown
#' @rdname hidden_aliases
#' @export
setMethod('[<-', signature(x = 'dbDataFrame', i = 'missing', j = 'missing', value = 'ANY'),
          function(x, i, j, value) {
            x@data = value
            x
          })


# internal function
# workaround for multiple dbplyr window column ordering
flex_window_order = function(x, order_cols) {
  keys = paste0('!!as.name("', order_cols, '")')
  keys = paste0(keys, collapse = ', ')
  call_str = paste0('x %>% dbplyr::window_order(', keys, ')')
  eval(str2lang(call_str))
}





# dbSpatProxyData ####

## rows only ####
# character input subsets the attribute table
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPolygonProxy', i = 'character', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x = reconnect(x)
    x@attributes@data = x@attributes@data %>%
      dplyr::select(i)
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPointsProxy', i = 'character', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x = reconnect(x)
    x@data = x@data %>%
      dplyr::select(c(.uID, x, y, i))
    x
  }
)
# numeric input subsets by row index
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPointsProxy', i = 'numeric', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x = reconnect(x)
    x@data = x@data %>%
      dplyr::filter(.uID %in% i)
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPointsProxy', i = 'logical', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x = reconnect(x)
    uIDs = x@data %>%
      dplyr::pull(.uID)
    bool_vect = uIDs[i]
    x@data = x@data %>%
      dplyr::filter(.uID %in% bool_vect)
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPolygonProxy', i = 'numeric', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x <- reconnect(x)
    x@data <- x@data %>%
      dplyr::filter(geom %in% i)
    x@attributes[] <- x@attributes[] %>%
      dplyr::filter(geom %in% i)
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPolygonProxy', i = 'logical', j = 'missing', drop = 'ANY'),
  function(x, i, ..., drop = FALSE) {
    x <- reconnect(x)
    geomIDs <- x@attributes[] %>%
      dplyr::pull(geom)
    bool_vect <- geomIDs[i]
    x@data <- x@data %>%
      dplyr::filter(geom %in% bool_vect)
    x@attributes[] <- x@attributes[] %>%
      dplyr::filter(geom %in% bool_vect)
    x
  }
)
## cols only ####
# character input subsets the attribute table
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPolygonProxy', i = 'missing', j = 'character', drop = 'ANY'),
  function(x, j, ..., drop = FALSE) {
    x = reconnect(x)
    x@attributes@data = x@attributes@data %>%
      dplyr::select(c(geom, dplyr::all_of(j)))
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPolygonProxy', i = 'missing', j = 'numeric', drop = 'ANY'),
  function(x, j, ..., drop = FALSE) {
    x = reconnect(x)
    sel_cols = names(x)[j]
    x@attributes@data = x@attributes@data %>%
      dplyr::select(c(geom, dplyr::all_of(sel_cols)))
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPolygonProxy', i = 'missing', j = 'character', drop = 'ANY'),
  function(x, j, ..., drop = FALSE) {
    x = reconnect(x)
    sel_cols = names(x)[j]
    x@attributes@data = x@attributes@data %>%
      dplyr::select(c(geom, dplyr::all_of(sel_cols)))
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPointsProxy', i = 'missing', j = 'character', drop = 'ANY'),
  function(x, j, ..., drop = FALSE) {
    x = reconnect(x)
    x@data = x@data %>%
      dplyr::select(c(.uID, x, y, dplyr::all_of(j)))
    x
  }
)
# numeric input subsets by row index
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPointsProxy', i = 'missing', j = 'numeric', drop = 'ANY'),
  function(x, j, ..., drop = FALSE) {
    x = reconnect(x)
    sel_cols = names(x)[j]
    x@data = x@data %>%
      dplyr::select(.uID, x, y, dplyr::all_of(sel_cols))
    x
  }
)
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbPointsProxy', i = 'missing', j = 'logical', drop = 'ANY'),
  function(x, j, ..., drop = FALSE) {
    x = reconnect(x)
    sel_cols = names(x)[j]
    x@data = x@data %>%
      dplyr::select(.uID, x, y, dplyr::all_of(sel_cols))
    x
  }
)

## rows and cols ####
# i char / j char NOT DEFINED
#
#' @rdname hidden_aliases
#' @export
setMethod(
  '[', signature(x = 'dbSpatProxyData', i = 'gdbIndexNonChar', j = 'gdbIndex', drop = 'ANY'),
  function(x, i, j, ..., drop = FALSE) {
    x = reconnect(x)
    x = x[, j, ..., drop]
    x = x[i, , ..., drop]
    x
  }
)





